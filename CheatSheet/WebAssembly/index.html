<!DOCTYPE html>
<html>
<head>
    <title>WASM Jump Game</title>
    <style>
        canvas {
            border: 1px solid black;
            background-color: #87CEEB;
        }
        #gameCanvas {
            display: block;
            margin: 20px auto;
        }
        #score {
            text-align: center;
            font-size: 24px;
            margin: 10px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="1800" height="1400"></canvas>
    <p>Score: <span id="score">0</span></p>
    <script src="wasm_exec.js"></script>
    <script>
        async function init() {
            try {
                const go = new Go();
                const result = await WebAssembly.instantiateStreaming(
                    fetch("main.wasm"),
                    go.importObject
                );
                await go.run(result.instance);
                startGame();
            } catch (err) {
                console.error('Failed to load WASM:', err);
            }
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');

        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space') {
                wasmJump();
                console.log("jump!")
            }
        });

        function drawPlayer(x, y) {
            ctx.fillStyle = 'red';
            ctx.fillRect(x, y, 30, 30);
        }

        function drawObstacle(x, y) {
            ctx.fillStyle = 'green';
            ctx.fillRect(x, y - 30, 30, 30);
        }

        function drawGame(gameState) {
            // JSON文字列をパース
            const state = JSON.parse(gameState);
            
            // 画面クリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 地面の描画
            ctx.fillStyle = 'brown';
            ctx.fillRect(0, 330, canvas.width, 70);

            // プレイヤーの描画
            drawPlayer(state.playerX, state.playerY);

            // 障害物の描画
            state.obstacles.forEach(obstacle => {
                drawObstacle(obstacle.x, obstacle.y);
            });

            // スコアの更新
            scoreElement.textContent = state.score;

            // ゲームオーバー処理
            if (state.isGameOver) {
                ctx.fillStyle = 'black';
                ctx.font = '48px Arial';
                ctx.fillText('Game Over!', 300, 200);
                return true;
            }
            return false;
        }

        function gameLoop() {
            const gameState = wasmUpdate();
            
            const isGameOver = drawGame(gameState);
            if (!isGameOver) {
                requestAnimationFrame(gameLoop);
            }
        }

        function startGame() {
            requestAnimationFrame(gameLoop);
        }

        startGame()
        init().catch(console.error);
    </script>
</body>
</html>