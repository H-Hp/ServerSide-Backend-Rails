<!DOCTYPE html>
<html>
<head>
    <title>WASM Jump Game</title>
    <style>
        canvas {
            border: 1px solid black;
            background-color: #87CEEB;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    <p>Score: <span id="score">0</span></p>

     <!-- 重要: wasm_exec.jsを最初に読み込む -->
     <script src="wasm_exec.js"></script>
     
    <script>
        // WebAssemblyの読み込み
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject)
            .then((result) => {
                go.run(result.instance);
                startGame();
            });

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');

        // キーボード入力の処理
        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space') {
                wasmJump();
            }
        });

        function drawPlayer(x, y) {
            ctx.fillStyle = 'red';
            ctx.fillRect(x, y, 30, 30);
        }

        function drawObstacle(x, y) {
            ctx.fillStyle = 'green';
            ctx.fillRect(x, y - 30, 30, 30);
        }

        function drawGame(gameState) {
            // 画面クリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 地面の描画
            ctx.fillStyle = 'brown';
            ctx.fillRect(0, 330, canvas.width, 70);

            // プレイヤーの描画
            drawPlayer(gameState.playerX, gameState.playerY);

            // 障害物の描画
            gameState.obstacles.forEach(obstacle => {
                drawObstacle(obstacle.X, obstacle.Y);
            });

            // スコアの更新
            scoreElement.textContent = gameState.score;

            // ゲームオーバー処理
            if (gameState.isGameOver) {
                ctx.fillStyle = 'black';
                ctx.font = '48px Arial';
                ctx.fillText('Game Over!', 300, 200);
                return true;
            }
            return false;
        }

        function gameLoop() {
            const gameState = wasmUpdate();
            const isGameOver = drawGame(gameState);
            if (!isGameOver) {
                requestAnimationFrame(gameLoop);
            }
        }

        function startGame() {
            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>